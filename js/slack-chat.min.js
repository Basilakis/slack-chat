/*SlackChat*/
/* v1.1 */
(function(c){var e={init:function(a){this._defaults={apiToken:"",channelId:"",user:"",userLink:"",userImg:"",userId:"",sysImg:"",sysUser:"",queryInterval:3E3,chatBoxHeader:"Need help? Talk to our support team right here",slackColor:"#36a64f",messageFetchCount:100,botUser:"",sendOnEnter:!0,disableIfAway:!1,elementToDisable:null,heightOffset:75,debug:!1,defaultUserImg:""};this._options=c.extend(!0,{},this._defaults,a);this._options.queryIntElem=null;this._options.latest=null;this._options.debug&&(console.log("This object :"),
console.log(this));""==this._options.apiToken&&e.validationError("Parameter apiToken is required.");""==this._options.channelId&&e.validationError("Parameter channelId is required.");""==this._options.user&&e.validationError("Parameter user is required.");""==this._options.sysUser&&e.validationError("Parameter sysUser is required.");""==this._options.botUser&&e.validationError("Parameter botUser is required.");"undefined"==typeof moment&&e.validationError("MomentJS is not available. Get it from http://momentjs.com");
this._options.disableIfAway&&null!==this._options.elementToDisable&&this._options.elementToDisable.hide();a='<div class="slackchat slack-chat-box"><div class="slack-chat-header"><button class="close slack-chat-close">&times;</button>';a+=this._options.chatBoxHeader;a+="<div class='presence'><div class='presence-icon'>&#8226;</div><div class='presence-text'></div></div>";a+="</div>";a+='<div class="slack-message-box">';a+="</div>";a+='<div class="send-area">';a+='<textarea class="form-control slack-new-message" type="text" placeholder="Write a message..."></textarea>';
a+='<div class="slack-post-message"><i class="fa fa-fw fa-chevron-right"></i></div>';a+="</div>";a+="</div>";c("body").append(a);var d=this;c(this).on("click",function(){c(".slack-chat-box").show();c(".slack-message-box").height(c(".slack-chat-box").height()-c(".desc").height()-c(".send-area").height()-parseInt(d._options.heightOffset));e.querySlack(d,d._options);d._options.queryIntElem=setInterval(function(){e.querySlack(d,d._options)},d._options.queryInterval);c(".slackchat .slack-new-message").focus()});
c(".slackchat .slack-chat-close").on("click",function(){c(".slack-chat-box").slideUp();clearInterval(d._options.queryIntElem)});c(".slackchat .slack-post-message").click(function(){e.postMessage(d,d._options)});c(".slackchat .slack-new-message").keyup(function(a){d._options.sendOnEnter&&13==(a.keyCode?a.keyCode:a.which)&&(e.postMessage(d,d._options),a.preventDefault())});e.getUserPresence(d,d._options)},querySlack:function(a){options=a._options;c.ajax({url:"https://slack.com/api/channels.history",
type:"POST",dataType:"json",data:{token:options.apiToken,channel:options.channelId,oldest:options.latest,count:options.messageFetchCount},success:function(a){options.debug&&a.messages.length&&console.log(a.messages);if(a.ok&&a.messages.length){var b="";options.latest=a.messages[0].ts;a.messages=a.messages.reverse();for(var f=0;f<a.messages.length;f++)if("bot_message"==a.messages[f].subtype&&""!==a.messages[f].text){message=a.messages[f];var g="",h="",k="";message.attachments&&(g=message.attachments[0].author_name,
h=message.attachments[0].author_icon);message.fields&&(k=message.fields[0].value);var l=e.checkforLinks(message.text.trim()),b=b+"<div class='message-item'>";""!==h?b+="<div class='userImg'><img src='"+h+"' /></div>":""!==options.defaultUserImg&&(b+="<div class='userImg'><img src='"+options.defaultUserImg+"' /></div>");b+="<div class='msgBox'>";b=""!==k?b+("<div class='username'>"+(k==options.userId?"You":g)+"</div>"):b+("<div class='username'>"+g+"</div>");b+="<div class='message'>"+l+"</div>";"undefined"!==
typeof moment&&(b+="<div class='timestamp'>"+moment.unix(a.messages[f].ts).fromNow()+"</div>");b+="</div>";b+="</div>"}else"undefined"==typeof a.messages[f].subtype&&(message=a.messages[f].text,g=options.sysUser,l=e.checkforLinks(message),b+="<div class='message-item'>",""!==options.sysImg&&(b+="<div class='userImg'><img src='"+options.sysImg+"' /></div>"),b+="<div class='msgBox'>",b+="<div class='username main'>"+g+"</div>",b+="<div class='message'>"+l+"</div>","undefined"!==typeof moment&&(b+="<div class='timestamp'>"+
moment.unix(a.messages[f].ts).fromNow()+"</div>"),b+="</div>",b+="</div>");c(".slack-message-box").append(b);c(".slack-message-box").stop().animate({scrollTop:c(".slack-message-box")[0].scrollHeight},800)}else a.ok||(console.log("[SlackChat] Query failed with errors: "),console.log(a))}})},postMessage:function(a){a=a._options;var d={};d.fallback="View "+a.user+"'s profile";d.color=a.slackColor;d.author_name=a.user;""!==a.userLink&&(d.author_link=a.userLink);""!==a.userImg&&(d.author_icon=a.userImg);
""!==a.userId&&(d.fields=[{title:"ID",value:a.userId,"short":!1}]);message=c(".slack-new-message").val();c(".slack-new-message").val("");a.debug&&(console.log("Posting Message:"),console.log({message:message,attachment:d,options:a}));c.ajax({url:"https://slack.com/api/chat.postMessage",type:"POST",dataType:"json",data:{token:a.apiToken,channel:a.channelId,text:message,username:a.botUser,attachments:JSON.stringify([d])},success:function(a){a.ok||(c(".slack-new-message").val(message),console.log("[SlackChat] Post Message failed with errors: "),
console.log(a))}})},validationError:function(a){c.error("[SlackChat Error] "+a);return!1},getUserPresence:function(a){var d=a._options,b=[];c.ajax({url:"https://slack.com/api/users.list",type:"POST",dataType:"json",data:{token:d.apiToken},success:function(a){if(a.ok&&(b=a.members,b.length))for(a=0;a<b.length;a++)b[a].is_bot||c.ajax({url:"https://slack.com/api/users.getPresence",dataType:"json",type:"POST",data:{token:d.apiToken,user:b[a].id},success:function(a){if(a.ok){if("active"===a.presence)return c(".slackchat .presence").addClass("active"),
c(".slackchat .presence .presence-text").text("Available"),d.disableIfAway&&null!==d.elementToDisable&&d.elementToDisable.show(),!0;c(".slackchat .presence").removeClass("active");c(".slackchat .presence .presence-text").text("Away")}}})}})},destroy:function(a){c(a).unbind("click");c(".slackchat").remove()},checkforLinks:function(a){var d=0;if(/.*<[a-zA-Z0-9\/:\-.]+|[a-zA-Z0-9\/:\-.]+>.*/.test(a))for(;d<=a.indexOf("<http");){linkStartIndex=a.indexOf("<http");linkEndIndex=a.indexOf(">",linkStartIndex)+
1;var b=a.substring(linkStartIndex,linkEndIndex),d=d+(linkStartIndex+a.indexOf(">")+1),c,e;c=b.substr(1,b.indexOf("|")-1);e=b.substring(b.indexOf("|")+1,b.length-1);a=a.replace(b,"<a href='"+c+"' target='_blank'>"+e+"</a>")}return a}};c.fn.slackChat=function(a){if(e[a])return e[a].apply(this,Array.prototype.slice.call(arguments,1));"object"!==typeof a&&a?c.error("Method "+a+" does not exist on jQuery.slackChat"):e.init.apply(this,arguments)}})(jQuery);